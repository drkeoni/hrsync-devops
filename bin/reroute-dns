#!/usr/bin/env python3
import sys
import boto3
import logging

LOG_FORMAT = "%(asctime)s %(filename)s [%(levelname)s] %(message)s"
log = logging.getLogger(__file__)
log.setLevel(logging.INFO)
ch = logging.StreamHandler()
ch.setFormatter(logging.Formatter(LOG_FORMAT))
log.addHandler(ch)

TAG_NAME = 'hrsync-server'
DNS_NAME = 'nasonstudios.net.'
PUBLIC_NAME = '{}.{}'.format('hrsync',DNS_NAME.rstrip('.'))
REGION = 'us-east-1'

ec2_client = boto3.client('ec2')
instance_info = ec2_client.describe_instances(
        Filters=[{'Name':'tag:Name', 'Values':[TAG_NAME]}]
)
instance_info = instance_info['Reservations'][0]['Instances'][0]
public_ip = instance_info['PublicIpAddress']
public_dns_name = instance_info['PublicDnsName']

dns_client = boto3.client('route53')
hosted_zone_id = dns_client.list_hosted_zones_by_name(DNSName=DNS_NAME)['HostedZones'][0]['Id']
hosted_zone_id2 = hosted_zone_id.rstrip('/').split('/')[-1]
#
#
#
log.info('Changing A record for {} to point to {}'.format(PUBLIC_NAME, public_ip))

change_request = {
    'Comment' : 'rerouting {}'.format(PUBLIC_NAME),
    'Changes': [
        {
            'Action': 'UPSERT',
            'ResourceRecordSet': {
                'Name': PUBLIC_NAME,
                'Type': 'A',
#                'Region': REGION,
#                'SetIdentifier': '1',
                'TTL': 300,
                'ResourceRecords': [
                    { 'Value': public_ip }
                ]
            }
        }]
}
#change_request['Changes'][0]['Action'] = 'DELETE'

response = dns_client.change_resource_record_sets( HostedZoneId=hosted_zone_id,
    ChangeBatch=change_request
)

log.info(response)
